# Evaluation

- **Status:** Accepted
- **Application Document:**  https://github.com/w3f/Grants-Program/blob/master/applications/societal_grant2.md
- **Milestone:** 2
- **Kusama Identity:** Address
- **Previously successfully merged evaluation:** N/A

| Number | Deliverable | Accepted | Link | Evaluation Notes |
| ------ | ----------- | -------- | ---- |----------------- |   
| 0a. | License | <ul><li>[x] </li></ul>|[GitHub repo link](https://github.com/sctllabs/societal-client/blob/main/LICENSE)|  |
| 0b. | Documentation | <ul><li>[x] </li></ul>|[GitHub repo link](https://github.com/sctllabs/societal-client/blob/main/README.md) | |
| 0c. | Testing Guide | <ul><li>[x] </li></ul>|[GitHub repo link](https://github.com/sctllabs/societal-client/blob/main/docs/DemocracyTestingGuide.md)|  |
| 0d. | Docker | <ul><li>[x] </li></ul>|[Docker Image](https://hub.docker.com/layers/societal/societal-client/da970f384c893cbac9f537b52535f7b5880e609b/images/sha256-2634da97a130abe3ce0ae3db18c73061f6374c7b0b889781d7d4d15ef8dc17be?context=explore)|   |
| 0e. | Article | <ul><li>[x] </li></ul>|[GitHub repo link](https://github.com/sctllabs/societal-grant-2-submission) |   |  
| 1. | Client Modules | <ul><li>[x] </li></ul>| [Societal Client Web Application](https://client.dev.sctl.link) |   |
| Note | Substrate Module: Reservable & Lockable Asset Pallet | <ul><li>[x] </li></ul>| |   |  

## Evaluation V4

The problem with docker was fixed.

## Evaluation V3

I had a small problem running the application using the docker script provided. After performing a workaround, the application worked well. See below the details of the docker problem.

I started by running the script provided.

```
./scripts/docker-run.sh 
*** Preparing environment ***
yarn install v1.22.19
warning package-lock.json found. Your project contains lock files generated by tools other than Yarn. It is advised not to mix package managers in order to avoid resolution inconsistencies caused by unsynchronized lock files. To clear this warning, remove package-lock.json.
[1/5] Validating package.json...
[2/5] Resolving packages...
[3/5] Fetching packages...
[4/5] Linking dependencies...
[5/5] Building fresh packages...
Done in 200.56s.

> build
> rm -rf lib && tsc

*** Start Societal Application ***
Stopping indexer-ingest     ... done
Stopping indexer-archive-db ... done
Removing indexer-ingest     ... done
Removing indexer-archive-db ... done
Removing network node-indexer_default
Creating network "node-indexer_default" with the default driver
Pulling node (societal/societal-node:be877873b212ccadef3eb4df431d3013d96002cc)...
be877873b212ccadef3eb4df431d3013d96002cc: Pulling from societal/societal-node
47c764472391: Pull complete
a995c0715e8f: Pull complete
1e5d15e33c86: Pull complete
dbcc067bf163: Pull complete
200fb5986e16: Pull complete
Digest: sha256:012bd2cb241f38a5aecc825adfd84589c6d3c9e2c03c6d495eac75183ad10af1
Status: Downloaded newer image for societal/societal-node:be877873b212ccadef3eb4df431d3013d96002cc
Pulling gateway (subsquid/substrate-gateway:firesquid)...
firesquid: Pulling from subsquid/substrate-gateway
3f9582a2cbe7: Pull complete
18fb28f76437: Pull complete
f6192aaac1a7: Pull complete
Digest: sha256:90f5d92b74cb2adf343149d3333f0fd49b6f66ac187b8e42ebdbd75d0da6f70d
Status: Downloaded newer image for subsquid/substrate-gateway:firesquid
Pulling explorer (subsquid/substrate-explorer:firesquid)...
firesquid: Pulling from subsquid/substrate-explorer
63b65145d645: Already exists
a67f65df360b: Already exists
6112f742730b: Already exists
4d4a28bae26a: Already exists
4ec194554210: Pull complete
4f4fb700ef54: Pull complete
Digest: sha256:0889a857f19246d391de298055e11046fe61b3fd45090b593dfce2fe8fb600a7
Status: Downloaded newer image for subsquid/substrate-explorer:firesquid
Pulling processor (societal/node-indexer:release-democracy-latest)...
ERROR: Head "https://registry-1.docker.io/v2/societal/node-indexer/manifests/release-democracy-latest": net/http: TLS handshake timeout

```
If you try to access the url `https://registry-1.docker.io/v2/societal/node-indexer/manifests/release-democracy-latest` directly it returns UNAUTHORIZED and asks for authentication.

Then I run the docker compose directly and the image was downloaded.


```
docker-compose -f docker-compose-full.yml up -d
```
And finished by running the migration with `make migrate`. Then the system spin up properly and worked fine. However, this problem with the docker script startup should be fixed.


## Evaluation V2

### Node-Indexer


I ran with docker and got this:

```
*** Waiting for containers to start ***
npm ERR! code E404
npm ERR! 404 Not Found - GET https://registry.npmjs.org/squid-typeorm-migration - Not found
npm ERR! 404
npm ERR! 404  'squid-typeorm-migration@*' is not in this registry.
npm ERR! 404
npm ERR! 404 Note that you can also install from a
npm ERR! 404 tarball, folder, http url, or git url.

npm ERR! A complete log of this run can be found in:
npm ERR! 	/home/user/.npm/_logs/2023-03-31T13_10_27_121Z-debug-0.log
make: *** [Makefile:24: migrate] Erro 1
```

I ran `npm run update` and `npm ci` outside docker and this was solved, but then got this error:
```
*** Waiting for containers to start ***
Error: Failed to resolve model /home/user/Documents/societal/node-indexer/lib/model. Did you forget to run codegen or compile the code?
	at resolveModel (/home/user/Documents/societal/node-indexer/node_modules/@subsquid/typeorm-config/lib/config.js:51:15)
	at createOrmConfig (/home/user/Documents/societal/node-indexer/node_modules/@subsquid/typeorm-config/lib/config.js:34:17)
	at /home/user/Documents/societal/node-indexer/node_modules/@subsquid/typeorm-migration/lib/apply.js:35:49
	at runProgram (/home/user/Documents/societal/node-indexer/node_modules/@subsquid/util-internal/lib/misc.js:61:9)
	at Object.<anonymous> (/home/user/Documents/societal/node-indexer/node_modules/@subsquid/typeorm-migration/lib/apply.js:31:32)
	at Module._compile (node:internal/modules/cjs/loader:1226:14)
	at Module._extensions..js (node:internal/modules/cjs/loader:1280:10)
	at Module.load (node:internal/modules/cjs/loader:1089:32)
	at Module._load (node:internal/modules/cjs/loader:930:12)
	at Module.require (node:internal/modules/cjs/loader:1113:19)
make: *** [Makefile:24: migrate] Erro 1
```

I ran `make build` outside docker and this was solved, and the docker finished running:

End of the docker command
```
query: ALTER TABLE "democracy_referendum" ADD CONSTRAINT "FK_a0f6113a7425e2b37295cac10ee" FOREIGN KEY ("democracy_proposal_id") REFERENCES "democracy_proposal"("id") ON DELETE NO ACTION ON UPDATE NO ACTION
query: ALTER TABLE "democracy_delegation" ADD CONSTRAINT "FK_5a74136a948246f86214372008a" FOREIGN KEY ("account_id") REFERENCES "account"("id") ON DELETE NO ACTION ON UPDATE NO ACTION
query: ALTER TABLE "democracy_delegation" ADD CONSTRAINT "FK_9142099c55927feb7648283a1e1" FOREIGN KEY ("target_id") REFERENCES "account"("id") ON DELETE NO ACTION ON UPDATE NO ACTION
query: INSERT INTO "migrations"("timestamp", "name") VALUES ($1, $2) -- PARAMETERS: [1679943081395,"Data1679943081395"]
Migration Data1679943081395 has been  executed successfully.
query: COMMIT
```

Docker Containers
```
user@localhost:~/Documents/societal/node-indexer$ docker ps
CONTAINER ID   IMAGE                                                         	COMMAND              	CREATED      	STATUS      	PORTS                                                                                                   	NAMES
363fa1b1c3cd   societal/societal-client:latest                               	"docker-entrypoint.s…"   52 seconds ago   Up 46 seconds   0.0.0.0:3000->3000/tcp, :::3000->3000/tcp                                                               	societal-client
307d3d86d490   subsquid/substrate-ingest:firesquid                           	"node /squid/substra…"   53 seconds ago   Up 44 seconds   9090/tcp                                                                                                	indexer-ingest
5c4c93288481   subsquid/substrate-explorer:firesquid                         	"node lib/main.js"   	53 seconds ago   Up 51 seconds   0.0.0.0:4444->3000/tcp, :::4444->3000/tcp                                                               	indexer-explorer
26fb9683d6c3   subsquid/substrate-gateway:firesquid                          	"/substrate-gateway/…"   53 seconds ago   Up 51 seconds   0.0.0.0:8888->8000/tcp, :::8888->8000/tcp                                                               	indexer-gateway
ab92da9afed6   okalenyk/node-indexer:latest                                  	"docker-entrypoint.s…"   53 seconds ago   Up 51 seconds   3000/tcp, 0.0.0.0:4350->4000/tcp, :::4350->4000/tcp                                                     	indexer-processor-query-node
7054226deeca   postgres:15                                                   	"docker-entrypoint.s…"   54 seconds ago   Up 53 seconds   0.0.0.0:5432->5432/tcp, :::5432->5432/tcp                                                               	indexer-archive-db
9e40927acb8e   postgres:15                                                   	"docker-entrypoint.s…"   54 seconds ago   Up 53 seconds   0.0.0.0:23798->5432/tcp, :::23798->5432/tcp                                                             	indexer-processor-db
f9608fd76372   societal/societal-node:be877873b212ccadef3eb4df431d3013d96002cc   "/usr/local/bin/soci…"   54 seconds ago   Up 53 seconds   0.0.0.0:9933->9933/tcp, :::9933->9933/tcp, 9615/tcp, 30333/tcp, 0.0.0.0:9944->9944/tcp, :::9944->9944/tcp   societal-node
```

I accessed http://localhost:3000/ and tried again, but got the same problems.

Here are some logs from docker, that report some errors:

subsquid/substrate-explorer:firesquid

```
docker logs 5c4c93288481 

{"level":3,"time":1680268476415,"ns":"sqd:substrate-explorer","msg":"failed to connect to postgres://postgres@archive-db:5432/squid-archive","err":{"errno":-111,"code":"ECONNREFUSED","syscall":"connect","address":"192.168.32.4","port":5432,"stack":"Error: connect ECONNREFUSED 192.168.32.4:5432\n    at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1278:16)"}}
{"level":2,"time":1680268476497,"ns":"sqd:substrate-explorer","msg":"listening on port 3000"}
```

Please review your docker compose and docker files in order to fix these errors. One hint to reproduce those errors is to start testing docker from a fresh cloned project. 


### Unit Test

I ran `cargo test` in the societal-grant, this time in the branch `release/democracy`. All tests passed, but I noticed this branch, only has 141 tests
and when I tested in the main branch has 176, of which 9 have been ignored.

### Code Quality

I still get too many warnings from clippy, but only from prebuilt pallets, like `dao-democracy` and `dao-assets`, and from `node/src/service.rs`.

## Evaluation V1

### Documentation

I didn't find any problem with the documentation.

### Docker

The docker works fine but I only used the docker from societal-client to launch the application connected with an external node. It is possible to use it with a local node?

### System Test

Using the local node, I tried to create a DAO. It was created in the node but doesn't appear in the frontend. Because of that, I wasn't able to finish this test using the local node. Do I need to change something for this to be working?

Using the external node, all the functions in the guide seem to be working fine.
However, when creating the DAO, I noticed the percentage circle in approve origin is not working.

![image (11)](https://user-images.githubusercontent.com/112647953/227263101-adade717-0306-494c-830e-f4d9b1d16d34.png)



### Unit Test

I ran `cargo test` in the societal-grant and got some warnings, and some tests were ignored, but all others passed.

```
warning: `pallet-dao-membership` (lib test) generated 15 warnings (run `cargo fix --lib -p pallet-dao-membership --tests` to apply 14 suggestions)
warning: `pallet-dao-collective` (lib test) generated 20 warnings (run `cargo fix --lib -p pallet-dao-collective --tests` to apply 12 suggestions)
	Finished test [unoptimized + debuginfo] target(s) in 1.97s
warning: the following packages contain code that will be rejected by a future version of Rust: fs_extra v1.2.0, nalgebra v0.27.1
note: to see what the problems were, use the option `--future-incompat-report`, or run `cargo report future-incompatibilities --id 1`
 	Running unittests src/lib.rs (target/debug/deps/dao_primitives-8b75baa477a4588b)
```
Ignored Tests
```
   Doc-tests precompile-utils
running 2 tests
test src/data/mod.rs - data::read_args (line 348) ... ignored
test src/data/mod.rs - data::read_struct (line 314) ... ignored
test result: ok. 0 passed; 0 failed; 2 ignored; 0 measured; 0 filtered out; finished in 0.00s
   Doc-tests precompile-utils-macro
running 8 tests
test src/lib.rs - generate_function_selector (line 68) ... ignored
test src/precompile/mod.rs - precompile (line 121) ... ignored
test src/precompile/mod.rs - precompile (line 157) ... ignored
test src/precompile/mod.rs - precompile (line 172) ... ignored
test src/precompile/mod.rs - precompile (line 34) ... ignored
test src/precompile/mod.rs - precompile (line 51) ... ignored
test src/precompile/mod.rs - precompile (line 96) ... ignored
test src/lib.rs - generate_function_selector (line 78) ... ok
test result: ok. 1 passed; 0 failed; 7 ignored; 0 measured; 0 filtered out; finished in 0.13s
```

I ran `yarn test` in the societal-client, and all tests passed.

```
user@localhost:~/Documents/societal/societal-client$ yarn test
yarn run v1.22.19
$ jest --silent
info  - Loaded env from /home/user/Documents/societal/societal-client/.env
 PASS  components/Countdown/Countdown.spec.tsx
 › 1 snapshot written.
 PASS  components/About/About.spec.tsx
 › 1 snapshot written.
 PASS  components/Token/Token.spec.tsx
 › 1 snapshot written.
 PASS  components/Balance/Balance.spec.tsx
 › 1 snapshot written.
 PASS  components/Hero/Hero.spec.tsx
 › 1 snapshot written.
 PASS  components/Queue/Queue.spec.tsx
 › 1 snapshot written.
 PASS  components/MainLoader/MainLoader.spec.tsx
 › 1 snapshot written.
 PASS  components/ui-kit/SidebarLink/SidebarLink.spec.tsx
 › 1 snapshot written.
 PASS  components/Search/Search.spec.tsx
 › 1 snapshot written.
 PASS  components/Overview/Overview.spec.tsx
 › 1 snapshot written.
 PASS  components/Members/Members.spec.tsx
 › 1 snapshot written.
 PASS  components/ConnectWallet/ConnectWallet.spec.tsx
 › 1 snapshot written.
Snapshot Summary
 › 12 snapshots written from 12 test suites.
Test Suites: 12 passed, 12 total
Tests:   	12 passed, 12 total
Snapshots:   12 written, 12 total
Time:    	3.561 s
Done in 7.18s.
```

### Code Quality

I ran `cargo clippy` and got too many warnings and some errors, for example:

```
warning: very complex type used. Consider factoring parts into `type` definitions
   --> node/src/service.rs:91:6
	|
91  |   ) -> Result<
	|  ______^
92  | | 	sc_service::PartialComponents<
93  | |     	FullClient,
94  | |     	FullBackend,
...   |
115 | | 	ServiceError,
116 | | > {
	| |_^
	|
	= help: for further information visit https://rust-lang.github.io/rust-clippy/master/index.html#type_complexity
	= note: `#[warn(clippy::type_complexity)]` on by default
warning: this function has too many arguments (8/7)
   --> node/src/service.rs:620:1
	|
620 | / fn spawn_frontier_tasks(
621 | | 	task_manager: &TaskManager,
622 | | 	client: Arc<FullClient>,
623 | | 	backend: Arc<FullBackend>,
...   |
628 | | 	fee_history_cache_limit: FeeHistoryCacheLimit,
629 | | ) {
	| |__^
	|
	= help: for further information visit https://rust-lang.github.io/rust-clippy/master/index.html#too_many_arguments
	= note: `#[warn(clippy::too_many_arguments)]` on by default
error: this looks like you are trying to swap `__clap_app` and `clap::Parser`
  --> node/src/cli.rs:46:17
   |
46 | #[derive(Debug, clap::Parser)]
   |             	^^^^^^^^^^^^
   |
   = note: or maybe you should use `std::mem::replace`?
   = help: for further information visit https://rust-lang.github.io/rust-clippy/master/index.html#almost_swapped
note: the lint level is defined here
  --> node/src/cli.rs:46:17
   |
46 | #[derive(Debug, clap::Parser)]
   |             	^^^^^^^^^^^^
   = note: `#[deny(clippy::almost_swapped)]` implied by `#[deny(clippy::correctness)]`
   = note: this error originates in the derive macro `clap::Parser` (in Nightly builds, run with -Z macro-backtrace for more info)
error: this looks like you are trying to swap `__clap_app` and `clap::Parser`
  --> node/src/cli.rs:46:17
   |
46 | #[derive(Debug, clap::Parser)]
   |             	^^^^^^^^^^^^
   |
   = note: or maybe you should use `std::mem::replace`?
   = help: for further information visit https://rust-lang.github.io/rust-clippy/master/index.html#almost_swapped
   = note: this error originates in the derive macro `clap::Parser` (in Nightly builds, run with -Z macro-backtrace for more info)
error: this looks like you are trying to swap `__clap_subcommand` and `clap::Subcommand`
  --> node/src/cli.rs:67:17
   |
67 | #[derive(Debug, clap::Subcommand)]
   |             	^^^^^^^^^^^^^^^^
   |
   = note: or maybe you should use `std::mem::replace`?
   = help: for further information visit https://rust-lang.github.io/rust-clippy/master/index.html#almost_swapped
note: the lint level is defined here
  --> node/src/cli.rs:67:17
   |
67 | #[derive(Debug, clap::Subcommand)]
   |             	^^^^^^^^^^^^^^^^
   = note: this error originates in the derive macro `clap::Subcommand` (in Nightly builds, run with -Z macro-backtrace for more info)
error: this looks like you are trying to swap `__clap_subcommand` and `clap::Subcommand`
  --> node/src/cli.rs:67:17
   |
67 | #[derive(Debug, clap::Subcommand)]
   |             	^^^^^^^^^^^^^^^^
   |
   = note: or maybe you should use `std::mem::replace`?
   = help: for further information visit https://rust-lang.github.io/rust-clippy/master/index.html#almost_swapped
   = note: this error originates in the derive macro `clap::Subcommand` (in Nightly builds, run with -Z macro-backtrace for more info)
warning: `societal-node` (bin "societal-node") generated 3 warnings
error: could not compile `societal-node` (bin "societal-node") due to 4 previous errors; 3 warnings emitted
```

I ran `yarn lint` in societal-client, and no warnings or error has returned

```
user@localhost:~/Documents/societal/societal-client$ yarn lint
yarn run v1.22.19
$ next lint
info  - Loaded env from /home/user/Documents/societal/societal-client/.env
✔ No ESLint warnings or errors
Done in 12.27s.
```

I ran `cargo tarpaulin` to check the coverage of the tests in societal-grant. Almost all `lib.rs` from pallets have low coverage, excluding dao-assets and dao-membership. The lib.rs from these pallets have more than 70% of coverage. The pallets dao-collective dao-primitives and dao-treasury have more than 50%, from dao 18,18%.
