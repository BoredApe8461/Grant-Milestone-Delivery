# Evaluation

- **Status:** In Progress
- **Application Document:** https://github.com/w3f/Grants-Program/blob/master/applications/Whiteflag-on-Fennel.md 
- **Milestone:** 1
- **Kusama Identity:** Address
- **Previously successfully merged evaluation:** Link

| Number | Deliverable | Accepted | Link | Evaluation Notes |
| ------ | ----------- | -------- | ---- |----------------- |
| 0a. | License |<ul><li>[x] </li></ul>| https://github.com/fennelLabs/Fennel-Protocol/blob/main/LICENSE | Unlicense | 
| 0b. | Documentation |<ul><li>[ ] </li></ul>| https://fennel-labs.notion.site/Grant-2-d6f134a5b65f4556823ae648e3b68e68, https://github.com/fennelLabs/Fennel-Protocol/wiki, https://fennellabs.com/Fennel-Protocol/doc/fennel_protocol_runtime/index.html, https://fennellabs.com/fennel-lib/fennel_lib/index.html, https://fennellabs.com/fennel-cli/fennel_cli/, https://fennellabs.com/fennel-server/fennel_server/ | The documentation listed here is more so for the previous grants, whereas the documentation on e.g. https://github.com/fennelLabs/fennel-app is just the default text generated by [create-react-app](https://github.com/facebook/create-react-app) | 
| 0c.  | Testing Guide |<ul><li>[ ] </li></ul>| https://fennel-labs.notion.site/Grant-2-Milestone-1-Testing-Guide-76b12a5e6e1149c2998d3e723cbaeb09, https://fennellabs.com/Fennel-Protocol/doc/fennel_protocol_runtime/index.html, https://github.com/fennelLabs/Fennel-Protocol/wiki/Testing-Milestone-3 | Some issues with automated testing of `fennel-app` & `fennel-cli`, see general notes | 
| 0d. | Docker |<ul><li>[x] </li></ul>| https://github.com/fennelLabs/Fennel-Protocol/blob/main/Dockerfile, https://github.com/fennelLabs/fennel-lib/blob/master/Dockerfile, https://github.com/fennelLabs/fennel-cli/blob/master/Dockerfile, https://github.com/fennelLabs/fennel-server/blob/master/Dockerfile, https://github.com/fennelLabs/fennel-api/blob/master/Dockerfile, https://github.com/fennelLabs/fennel-api/blob/master/Dockerfile | Initial issues with docker were quickly resolved by the team | 
| 0e. | Article |<ul><li>[x] </li></ul>| https://fennel-labs.notion.site/Fennel-Platform-ac95115aea7542c8bae06a168e314042 | Announcement article of webapp prototype. |
| 0f. | User-Facing Article |<ul><li>[ ] </li></ul>| https://fennel-labs.notion.site/User-Guide-064b8c8de58f4e2a8206b3c5229fecc9 | I think this article could use some more information and walkthrough of how to use the app and confirm everything is working, by sending a message to oneself and finding it in the inbox, for example. |
| 1. | Encryption and Message Tie-Ins |<ul><li>[ ] </li></ul>| https://github.com/fennelLabs/fennel-app, https://github.com/fennelLabs/fennel-api, https://github.com/fennelLabs/fennel-app/blob/master/src/services/rpc.service.js#L201, https://github.com/fennelLabs/fennel-app/blob/master/src/services/MessageAPI/index.js, https://github.com/fennelLabs/fennel-app/blob/master/src/services/ContactsManager.service.js, https://github.com/fennelLabs/fennel-app/blob/master/src/services/MessageEncryptionIndicatorsManager.service.js | Identity creation, key generation, and unencrypted message send/receive are working on the frontend. However, the `manage contacts` tab seems a bit unclear - keypairs generated by the user automatically get added, but how can the user add or delete contacts themselves? |
| 2. | Fennel Protocol Tie-Ins |<ul><li>[x] </li></ul>| https://github.com/fennelLabs/Fennel-Protocol, https://github.com/fennelLabs/fennel-app/blob/master/src/services/Node/index.js, https://github.com/fennelLabs/fennel-app/blob/master/src/services/KeyManager/index.js | |
| 3. | Whiteflag Message Support |<ul><li>[ ] </li></ul>| https://github.com/fennelLabs/whiteflag-rust, https://github.com/fennelLabs/fennel-cli/blob/5886d6297307624c89fc258c3dd75c64b08ef712/src/fennel_rpc/mod.rs#L86, https://github.com/fennelLabs/fennel-cli/blob/5886d6297307624c89fc258c3dd75c64b08ef712/src/fennel_rpc/mod.rs#L92, https://github.com/fennelLabs/fennel-app/blob/c09e42656bb6f906c8493307b49b0dcdc4526b58/src/services/rpc.service.js#L191, https://github.com/fennelLabs/fennel-app/blob/c09e42656bb6f906c8493307b49b0dcdc4526b58/src/services/rpc.service.js#L201 | This works with normal inputs, but malformed inputs will error silently and cause the websocket to clause (more info in general notes) |



## General Notes

## Fennel-App

* Overall, while the integration with the protocol is working, the webapp has very limited feedback on the users actions. It's pretty much a requirement to have the console open in order to spot errors or confirmation messages, and even then it's hard to tell what's going wrong if something does go wrong.

* In order to be more user friendly, more messages need to be shown on screen - loading messages & error messages with possible causes. There are some confirmation messages, but they are often vague i.e. simply inserting 'Success!' to some text element.

* As said in the table above, some more specific documentation would be ideal in the repo.

* In addition, there should be some unit tests to confirm that components are working as expected - currently `npm run test` shows that no unit tests exist.


### `/whiteflag`


Deleting a 0 in the default `"referencedMessage"` closes the websocket connection and requires user to press `open rpc` in order to reconnect. Only `web socket closed!` is shown in the console, and it's probably being caused by this panic in `fennel-cli`:

```
thread 'tokio-runtime-worker' panicked at 'called `Result::unwrap()` on an `Err` value: InvalidPattern', /Users/lucasvanmol/.cargo/git/checkouts/whiteflag-rust-5af04557557d3e18/7290352/src/wf_core/segment.rs:37:39
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
```

(Ideally there should be no `Result::unwrap()` in Rust code, and it should be dealt with without panicking - unless, of course, it's clear an unwrap will never panic, in which case you should use `Result::expect()`)

### `/wallet`

I understand this is more of a prototype, but you would need integration with the polkadot.js extension (atleast, as an option) in order to, for example, sign transactions, if the prototype ever gets deployed. Any user would be very weary of importing a wallet by enter mnemonics if they had some valuable tokens in their wallet.

## Fennel-Cli

Running `cargo test` on fennel-cli seems to cause some issues:

```
fennel-cli % cargo test                 
    Finished test [unoptimized + debuginfo] target(s) in 0.15s
     Running unittests src/main.rs (target/debug/deps/fennel_cli-6e87c4ce7e73170d)

running 7 tests
test client::tests::test_pack_message ... ok
test client::tests::test_unpack_message ... ok
test client::tests::test_handle_backlog_decrypt_with_dh ... FAILED
test client::tests::test_handle_sign_and_verify ... FAILED
test client::tests::test_handle_backlog_decrypt ... FAILED
test client::tests::test_diffie_hellman ... ok
test client::tests::test_handle_encrypt_and_decrypt ... ok

failures:

---- client::tests::test_handle_backlog_decrypt_with_dh stdout ----
thread 'client::tests::test_handle_backlog_decrypt_with_dh' panicked at 'called `Result::unwrap()` on an `Err` value: Error { message: "IO error: lock hold by current process, acquire time 1656583164 acquiring thread 6100955136: ./identity.db/LOCK: No locks available" }', /Users/lucasvanmol/.cargo/git/checkouts/fennel-lib-177977e1625f825c/1b383df/src/database/mod.rs:38:59
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

---- client::tests::test_handle_sign_and_verify stdout ----
thread 'client::tests::test_handle_sign_and_verify' panicked at 'called `Result::unwrap()` on an `Err` value: Error { message: "IO error: lock hold by current process, acquire time 1656583164 acquiring thread 6100955136: ./identity.db/LOCK: No locks available" }', /Users/lucasvanmol/.cargo/git/checkouts/fennel-lib-177977e1625f825c/1b383df/src/database/mod.rs:38:59

---- client::tests::test_handle_backlog_decrypt stdout ----
thread 'client::tests::test_handle_backlog_decrypt' panicked at 'called `Result::unwrap()` on an `Err` value: Error { message: "IO error: lock hold by current process, acquire time 1656583164 acquiring thread 6100955136: ./identity.db/LOCK: No locks available" }', /Users/lucasvanmol/.cargo/git/checkouts/fennel-lib-177977e1625f825c/1b383df/src/database/mod.rs:38:59


failures:
    client::tests::test_handle_backlog_decrypt
    client::tests::test_handle_backlog_decrypt_with_dh
    client::tests::test_handle_sign_and_verify

test result: FAILED. 4 passed; 3 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.37s

error: test failed, to rerun pass '--bin fennel-cli'
```


#### Commit hashes used for this evaluation:

* `Fennel-Protocol`: 1e9de24

* `fennel-api`: e7e0158

* `fennel-app`: 55eef68

* `fennel-cli`: 5886d62